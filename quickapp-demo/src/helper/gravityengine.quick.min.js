"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var fetch=_interopDefault(require("@system.fetch")),device=_interopDefault(require("@system.device")),network=_interopDefault(require("@system.network")),storage=_interopDefault(require("@system.storage")),prompt=_interopDefault(require("@system.prompt"));function _regeneratorRuntime(){_regeneratorRuntime=function(){return s};var s={},e=Object.prototype,c=e.hasOwnProperty,u=Object.defineProperty||function(e,t,r){e[t]=r.value},t="function"==typeof Symbol?Symbol:{},n=t.iterator||"@@iterator",r=t.asyncIterator||"@@asyncIterator",i=t.toStringTag||"@@toStringTag";function o(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{o({},"")}catch(e){o=function(e,t,r){return e[t]=r}}function a(e,t,r,n){var i,o,s,a,t=t&&t.prototype instanceof f?t:f,t=Object.create(t.prototype),n=new k(n||[]);return u(t,"_invoke",{value:(i=e,o=r,s=n,a="suspendedStart",function(e,t){if("executing"===a)throw new Error("Generator is already running");if("completed"===a){if("throw"===e)throw t;return{value:void 0,done:!0}}for(s.method=e,s.arg=t;;){var r=s.delegate;if(r){r=function e(t,r){var n=r.method,i=t.iterator[n];if(void 0===i)return r.delegate=null,"throw"===n&&t.iterator.return&&(r.method="return",r.arg=void 0,e(t,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),p;n=l(i,t.iterator,r.arg);if("throw"===n.type)return r.method="throw",r.arg=n.arg,r.delegate=null,p;i=n.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,p):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,p)}(r,s);if(r){if(r===p)continue;return r}}if("next"===s.method)s.sent=s._sent=s.arg;else if("throw"===s.method){if("suspendedStart"===a)throw a="completed",s.arg;s.dispatchException(s.arg)}else"return"===s.method&&s.abrupt("return",s.arg);a="executing";r=l(i,o,s);if("normal"===r.type){if(a=s.done?"completed":"suspendedYield",r.arg===p)continue;return{value:r.arg,done:s.done}}"throw"===r.type&&(a="completed",s.method="throw",s.arg=r.arg)}})}),t}function l(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}s.wrap=a;var p={};function f(){}function h(){}function d(){}var t={},m=(o(t,n,function(){return this}),Object.getPrototypeOf),m=m&&m(m(w([]))),g=(m&&m!==e&&c.call(m,n)&&(t=m),d.prototype=f.prototype=Object.create(t));function _(e){["next","throw","return"].forEach(function(t){o(e,t,function(e){return this._invoke(t,e)})})}function y(s,a){var t;u(this,"_invoke",{value:function(r,n){function e(){return new a(function(e,t){!function t(e,r,n,i){var o,e=l(s[e],s,r);if("throw"!==e.type)return(r=(o=e.arg).value)&&"object"==typeof r&&c.call(r,"__await")?a.resolve(r.__await).then(function(e){t("next",e,n,i)},function(e){t("throw",e,n,i)}):a.resolve(r).then(function(e){o.value=e,n(o)},function(e){return t("throw",e,n,i)});i(e.arg)}(r,n,e,t)})}return t=t?t.then(e,e):e()}})}function v(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function b(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function k(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(v,this),this.reset(!0)}function w(t){if(t||""===t){var r,e=t[n];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length))return r=-1,(e=function e(){for(;++r<t.length;)if(c.call(t,r))return e.value=t[r],e.done=!1,e;return e.value=void 0,e.done=!0,e}).next=e}throw new TypeError(typeof t+" is not iterable")}return u(g,"constructor",{value:h.prototype=d,configurable:!0}),u(d,"constructor",{value:h,configurable:!0}),h.displayName=o(d,i,"GeneratorFunction"),s.isGeneratorFunction=function(e){e="function"==typeof e&&e.constructor;return!!e&&(e===h||"GeneratorFunction"===(e.displayName||e.name))},s.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,o(e,i,"GeneratorFunction")),e.prototype=Object.create(g),e},s.awrap=function(e){return{__await:e}},_(y.prototype),o(y.prototype,r,function(){return this}),s.AsyncIterator=y,s.async=function(e,t,r,n,i){void 0===i&&(i=Promise);var o=new y(a(e,t,r,n),i);return s.isGeneratorFunction(t)?o:o.next().then(function(e){return e.done?e.value:o.next()})},_(g),o(g,i,"Generator"),o(g,n,function(){return this}),o(g,"toString",function(){return"[object Generator]"}),s.keys=function(e){var t,r=Object(e),n=[];for(t in r)n.push(t);return n.reverse(),function e(){for(;n.length;){var t=n.pop();if(t in r)return e.value=t,e.done=!1,e}return e.done=!0,e}},s.values=w,k.prototype={constructor:k,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(b),!e)for(var t in this)"t"===t.charAt(0)&&c.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(r){if(this.done)throw r;var n=this;function e(e,t){return o.type="throw",o.arg=r,n.next=e,t&&(n.method="next",n.arg=void 0),!!t}for(var t=this.tryEntries.length-1;0<=t;--t){var i=this.tryEntries[t],o=i.completion;if("root"===i.tryLoc)return e("end");if(i.tryLoc<=this.prev){var s=c.call(i,"catchLoc"),a=c.call(i,"finallyLoc");if(s&&a){if(this.prev<i.catchLoc)return e(i.catchLoc,!0);if(this.prev<i.finallyLoc)return e(i.finallyLoc)}else if(s){if(this.prev<i.catchLoc)return e(i.catchLoc,!0)}else{if(!a)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return e(i.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;0<=r;--r){var n=this.tryEntries[r];if(n.tryLoc<=this.prev&&c.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var i=n;break}}var o=(i=i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc?null:i)?i.completion:{};return o.type=e,o.arg=t,i?(this.method="next",this.next=i.finallyLoc,p):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),p},finish:function(e){for(var t=this.tryEntries.length-1;0<=t;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),b(r),p}},catch:function(e){for(var t=this.tryEntries.length-1;0<=t;--t){var r,n,i=this.tryEntries[t];if(i.tryLoc===e)return"throw"===(r=i.completion).type&&(n=r.arg,b(i)),n}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:w(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),p}},s}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function asyncGeneratorStep(e,t,r,n,i,o,s){try{var a=e[o](s),c=a.value}catch(e){return void r(e)}a.done?t(c):Promise.resolve(c).then(n,i)}function _asyncToGenerator(a){return function(){var e=this,s=arguments;return new Promise(function(t,r){var n=a.apply(e,s);function i(e){asyncGeneratorStep(n,t,r,i,o,"next",e)}function o(e){asyncGeneratorStep(n,t,r,i,o,"throw",e)}i(void 0)})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,_toPropertyKey(n.key),n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _defineProperty(e,t,r){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _toPrimitive(e,t){if("object"!=typeof e||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);r=r.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"==typeof e?e:String(e)}var Config={LIB_VERSION:"4.7.10",LIB_NAME:"MP",LIB_STACK:"QuickApp",BASE_URL:"https://backend.gravity-engine.com/event_center/api/v1"},_={},ArrayProto=Array.prototype,ObjProto=Object.prototype,slice=ArrayProto.slice,nativeToString=ObjProto.toString,nativeHasOwnProperty=Object.prototype.hasOwnProperty,nativeForEach=ArrayProto.forEach,nativeIsArray=Array.isArray,breaker={},logger=(_.isNumber=function(e){return"number"==typeof e?0==e-e:"string"==typeof e&&""!==e.trim()&&(Number.isFinite?Number.isFinite(+e):isFinite(+e))},_.each=function(e,t,r){if(null==e)return!1;if(nativeForEach&&e.forEach===nativeForEach)e.forEach(t,r);else if(e.length===+e.length){for(var n=0,i=e.length;n<i;n++)if(n in e&&t.call(r,e[n],n,e)===breaker)return!1}else for(var o in e)if(nativeHasOwnProperty.call(e,o)&&t.call(r,e[o],o,e)===breaker)return!1},_.sleep=function(t){return new Promise(function(e){return setTimeout(e,t)})},_.extend=function(r){return _.each(slice.call(arguments,1),function(e){for(var t in e)void 0!==e[t]&&(r[t]=e[t])}),r},_.extend2Layers=function(r){return _.each(slice.call(arguments,1),function(e){for(var t in e)void 0!==e[t]&&(_.isObject(e[t])&&_.isObject(r[t])?_.extend(r[t],e[t]):r[t]=e[t])}),r},_.isArray=nativeIsArray||function(e){return"[object Array]"===nativeToString.call(e)},_.isFunction=function(e){try{return"function"==typeof e}catch(e){return!1}},_.isPromise=function(e){return"[object Promise]"===nativeToString.call(e)&&null!=e},_.isObject=function(e){return"[object Object]"===nativeToString.call(e)&&null!=e},_.isEmptyObject=function(e){if(_.isObject(e)){for(var t in e)if(nativeHasOwnProperty.call(e,t))return!1;return!0}return!1},_.isUndefined=function(e){return void 0===e},_.isString=function(e){return"[object String]"===nativeToString.call(e)},_.isDate=function(e){return"[object Date]"===nativeToString.call(e)},_.isBoolean=function(e){return"[object Boolean]"===nativeToString.call(e)},_.isNumber=function(e){return"[object Number]"===nativeToString.call(e)&&/[\d\.]+/.test(String(e))},_.isJSONString=function(e){try{JSON.parse(e)}catch(e){return!1}return!0},_.decodeURIComponent=function(t){var r="";try{r=decodeURIComponent(t)}catch(e){r=t}return r},_.encodeURIComponent=function(t){var r="";try{r=encodeURIComponent(t)}catch(e){r=t}return r},_.utf8Encode=function(e){for(var t,r="",n=t=0,i=(e=(e+"").replace(/\r\n/g,"\n").replace(/\r/g,"\n")).length,o=0;o<i;o++){var s=e.charCodeAt(o),a=null;s<128?t++:a=127<s&&s<2048?String.fromCharCode(s>>6|192,63&s|128):String.fromCharCode(s>>12|224,s>>6&63|128,63&s|128),null!==a&&(n<t&&(r+=e.substring(n,t)),r+=a,n=t=o+1)}return n<t&&(r+=e.substring(n,e.length)),r},_.base64Encode=function(e){var t,r,n,i,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",s=0,a=0,c="",u=[];if(!e)return e;for(e=_.utf8Encode(e);t=(i=e.charCodeAt(s++)<<16|e.charCodeAt(s++)<<8|e.charCodeAt(s++))>>12&63,r=i>>6&63,n=63&i,u[a++]=o.charAt(i>>18&63)+o.charAt(t)+o.charAt(r)+o.charAt(n),s<e.length;);switch(c=u.join(""),e.length%3){case 1:c=c.slice(0,-2)+"==";break;case 2:c=c.slice(0,-1)+"="}return c},_.encodeDates=function(n){return _.each(n,function(e,t){if(_.isDate(e))n[t]=_.formatDate(e);else if(_.isObject(e))n[t]=_.encodeDates(e);else if(_.isArray(e))for(var r=0;r<e.length;r++)_.isDate(e[r])&&(n[t][r]=_.formatDate(e[r]))}),n},_.formatDate=function(e){function t(e){return e<10?"0"+e:e}return e.getFullYear()+"-"+t(e.getMonth()+1)+"-"+t(e.getDate())+" "+t(e.getHours())+":"+t(e.getMinutes())+":"+t(e.getSeconds())+"."+((e=e.getMilliseconds())<100&&9<e?"0"+e:e<10?"00"+e:e)},_.searchObjDate=function(r){try{(_.isObject(r)||_.isArray(r))&&_.each(r,function(e,t){_.isObject(e)||_.isArray(e)?_.searchObjDate(r[t]):_.isDate(e)&&(r[t]=_.formatDate(e))})}catch(e){logger.warn(e)}},_.UUID=function(){var e=(new Date).getTime();return String(Math.random()).replace(".","").slice(1,11)+"-"+e},_.UUIDv4=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})},_.setMpPlatform=function(e){_.mpPlatform=e},_.getMpPlatform=function(){return _.mpPlatform},_.createExtraHeaders=function(){return{"GE-Integration-Type":Config.LIB_NAME,"GE-Integration-Version":Config.LIB_VERSION,"GE-Integration-Count":"1","GE-Integration-Extra":_.getMpPlatform()}},_.checkAppId=function(e){if("number"==typeof e)e=String(e);else if("string"!=typeof e)return"";return e=e.replace(/\s*/g,"")},_.checkUrl=function(e){return e=e.replace(/\s*/g,""),e=_.url("basic",e)},_.url=function(){function i(){return new RegExp(/(.*?)\.?([^.]*?)\.(com|net|org|biz|ws|in|me|co\.uk|co|org\.uk|ltd\.uk|plc\.uk|me\.uk|edu|mil|br\.com|cn\.com|eu\.com|hu\.com|no\.com|qc\.com|sa\.com|se\.com|se\.net|us\.com|uy\.com|ac|co\.ac|gv\.ac|or\.ac|ac\.ac|af|am|as|at|ac\.at|co\.at|gv\.at|or\.at|asn\.au|com\.au|edu\.au|org\.au|net\.au|id\.au|be|ac\.be|adm\.br|adv\.br|am\.br|arq\.br|art\.br|bio\.br|cng\.br|cnt\.br|com\.br|ecn\.br|eng\.br|esp\.br|etc\.br|eti\.br|fm\.br|fot\.br|fst\.br|g12\.br|gov\.br|ind\.br|inf\.br|jor\.br|lel\.br|med\.br|mil\.br|net\.br|nom\.br|ntr\.br|odo\.br|org\.br|ppg\.br|pro\.br|psc\.br|psi\.br|rec\.br|slg\.br|tmp\.br|tur\.br|tv\.br|vet\.br|zlg\.br|br|ab\.ca|bc\.ca|mb\.ca|nb\.ca|nf\.ca|ns\.ca|nt\.ca|on\.ca|pe\.ca|qc\.ca|sk\.ca|yk\.ca|ca|cc|ac\.cn|net\.cn|com\.cn|edu\.cn|gov\.cn|org\.cn|bj\.cn|sh\.cn|tj\.cn|cq\.cn|he\.cn|nm\.cn|ln\.cn|jl\.cn|hl\.cn|js\.cn|zj\.cn|ah\.cn|gd\.cn|gx\.cn|hi\.cn|sc\.cn|gz\.cn|yn\.cn|xz\.cn|sn\.cn|gs\.cn|qh\.cn|nx\.cn|xj\.cn|tw\.cn|hk\.cn|mo\.cn|cn|cx|cz|de|dk|fo|com\.ec|tm\.fr|com\.fr|asso\.fr|presse\.fr|fr|gf|gs|co\.il|net\.il|ac\.il|k12\.il|gov\.il|muni\.il|ac\.in|co\.in|org\.in|ernet\.in|gov\.in|net\.in|res\.in|is|it|ac\.jp|co\.jp|go\.jp|or\.jp|ne\.jp|ac\.kr|co\.kr|go\.kr|ne\.kr|nm\.kr|or\.kr|li|lt|lu|asso\.mc|tm\.mc|com\.mm|org\.mm|net\.mm|edu\.mm|gov\.mm|ms|nl|no|nu|pl|ro|org\.ro|store\.ro|tm\.ro|firm\.ro|www\.ro|arts\.ro|rec\.ro|info\.ro|nom\.ro|nt\.ro|se|si|com\.sg|org\.sg|net\.sg|gov\.sg|sk|st|tf|ac\.th|co\.th|go\.th|mi\.th|net\.th|or\.th|tm|to|com\.tr|edu\.tr|gov\.tr|k12\.tr|net\.tr|org\.tr|com\.tw|org\.tw|net\.tw|ac\.uk|uk\.com|uk\.net|gb\.com|gb\.net|vg|sh|kz|ch|info|ua|gov|name|pro|ie|hk|com\.hk|org\.hk|net\.hk|edu\.hk|us|tk|cd|by|ad|lv|eu\.lv|bz|es|jp|cl|ag|mobi|eu|co\.nz|org\.nz|net\.nz|maori\.nz|iwi\.nz|io|la|md|sc|sg|vc|tw|travel|my|se|tv|pt|com\.pt|edu\.pt|asia|fi|com\.ve|net\.ve|fi|org\.ve|web\.ve|info\.ve|co\.ve|tel|im|gr|ru|net\.ru|org\.ru|hr|com\.hr|ly|xyz)$/)}function o(e,t){var r=e.charAt(0),t=t.split(r);return r===e?t:t[(e=parseInt(e.substring(1),10))<0?t.length+e:e-1]}function s(e,t){for(var r,n=e.charAt(0),i=t.split("&"),o=[],s={},a=e.substring(1),c=0,u=i.length;c<u;c++)if(""!==(o=(o=i[c].match(/(.*?)=(.*)/))||[i[c],i[c],""])[1].replace(/\s/g,"")){if(o[2]=(r=o[2]||"",_.decodeURIComponent(r.replace(/\+/g," "))),a===o[1])return o[2];(r=o[1].match(/(.*)\[([0-9]+)\]/))?(s[r[1]]=s[r[1]]||[],s[r[1]][r[2]]=o[2]):s[o[1]]=o[2]}return n===e?s:s[a]}return function(e,t){var r,n={};if("tld?"===e)return i();if(t=t||window.location.toString(),!e)return t;if(e=e.toString(),t.match(/^mailto:([^/].+)/))r=t.match(/^mailto:([^/].+)/),n.protocol="mailto",n.email=r[1];else{if((t=t.match(/(.*?)\/#!(.*)/)?(r=t.match(/(.*?)\/#!(.*)/))[1]+r[2]:t).match(/(.*?)#(.*)/)&&(r=t.match(/(.*?)#(.*)/),n.hash=r[2],t=r[1]),n.hash&&e.match(/^#/))return s(e,n.hash);if(t.match(/(.*?)\?(.*)/)&&(r=t.match(/(.*?)\?(.*)/),n.query=r[2],t=r[1]),n.query&&e.match(/^\?/))return s(e,n.query);if(t.match(/(.*?):?\/\/(.*)/)&&(r=t.match(/(.*?):?\/\/(.*)/),n.protocol=r[1].toLowerCase(),t=r[2]),t.match(/(.*?)(\/.*)/)&&(r=t.match(/(.*?)(\/.*)/),n.path=r[2],t=r[1]),n.path=(n.path||"").replace(/^([^/])/,"/$1").replace(/\/$/,""),(e=e.match(/^[-0-9]+$/)?e.replace(/^([^/])/,"/$1"):e).match(/^\//))return o(e,n.path.substring(1));if((r=(r=o("/-1",n.path.substring(1)))&&r.match(/(.*?)\.(.*)/))&&(n.file=r[0],n.filename=r[1],n.fileext=r[2]),t.match(/(.*):([0-9]+)$/)&&(r=t.match(/(.*):([0-9]+)$/),n.port=r[2],t=r[1]),t.match(/(.*?)@(.*)/)&&(r=t.match(/(.*?)@(.*)/),n.auth=r[1],t=r[2]),n.auth&&(r=n.auth.match(/(.*):(.*)/),n.user=r?r[1]:n.auth,n.pass=r?r[2]:void 0),n.hostname=t.toLowerCase(),"."===e.charAt(0))return o(e,n.hostname);i()&&(r=n.hostname.match(i()))&&(n.tld=r[3],n.domain=r[2]?r[2]+"."+r[3]:void 0,n.sub=r[1]||void 0);t=n.port?":"+n.port:"";n.protocol=n.protocol||window.location.protocol.replace(":",""),n.port=n.port||("https"===n.protocol?"443":"80"),n.protocol=n.protocol||("443"===n.port?"https":"http"),n.basic=n.protocol+"://"+n.hostname+t}return e in n?n[e]:"{}"===e?n:""}}(),_.createString=function(e){for(var t=e,r=Math.random().toString(36).substr(2);r.length<t;)r+=Math.random().toString(36).substr(2);return r=r.substr(0,e)},_.createAesKey=function(){return _.createString(16)},_.setQuery=function(e){var t,r=[];for(t in e)e.hasOwnProperty(t)&&r.push(encodeURIComponent(t)+"="+encodeURIComponent(e[t]));return r.join("&")},_.generateEncryptyData=function(e,t){if(void 0!==t){var r=t.publicKey,t=t.version;if(void 0!==r&&void 0!==t&&"undefined"!=typeof CryptoJS&&"undefined"!=typeof JSEncrypt){var n=_.createAesKey();try{var i=CryptoJS.enc.Utf8.parse(n),o=CryptoJS.enc.Utf8.parse(JSON.stringify(e)),s=_.isUndefined(CryptoJS.pad.Pkcs7)?CryptoJS.pad.PKCS7:CryptoJS.pad.Pkcs7,a=CryptoJS.AES.encrypt(o,i,{mode:CryptoJS.mode.ECB,padding:s}).toString(),c=new JSEncrypt,u=(c.setPublicKey(r),c.encrypt(n));return!1===u?(logger.warn("私钥加密失败，返回原数据"),e):{pkv:t,ekey:u,payload:a}}catch(e){logger.warn("数据加密失败，返回原数据: "+e)}}}return e},"object"===_typeof(logger)?logger:{}),KEY_NAME_MATCH_REGEX=(logger.info=function(){if("object"===("undefined"==typeof console?"undefined":_typeof(console))&&console.log&&logger.enabled)try{return console.log.apply(console,arguments)}catch(e){console.log(arguments[0])}},logger.warn=function(){if("object"===("undefined"==typeof console?"undefined":_typeof(console))&&console.log&&logger.enabled)try{return console.warn.apply(console,arguments)}catch(e){console.warn(arguments[0])}},/^\$?[a-zA-Z][a-zA-Z0-9_]{0,49}$/),PropertyChecker=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"stripProperties",value:function(e){return _.isObject(e)&&_.each(e,function(e,t){_.isString(e)||_.isNumber(e)||_.isDate(e)||_.isBoolean(e)||_.isArray(e)||_.isObject(e)||logger.warn("Your data -",t,e,"- format does not meet requirements and may not be stored correctly. Attribute values only support String, Number, Date, Boolean, Array, Object")}),e}},{key:"_checkPropertiesKey",value:function(e){var r=!0;return _.each(e,function(e,t){KEY_NAME_MATCH_REGEX.test(t)||(logger.warn("Invalid KEY: "+t),r=!1)}),r}},{key:"event",value:function(e){return!(!_.isString(e)||!KEY_NAME_MATCH_REGEX.test(e))||(logger.warn("Check the parameter format. The eventName must start with an English letter and contain no more than 50 characters including letters, digits, and underscores: "+e),!1)}},{key:"propertyName",value:function(e){return!(!_.isString(e)||!KEY_NAME_MATCH_REGEX.test(e))||(logger.warn("Check the parameter format. PropertyName must start with a letter and contain letters, digits, and underscores (_). The value is a string of no more than 50 characters: "+e),!1)}},{key:"properties",value:function(e){return this.stripProperties(e),!(e&&(_.isObject(e)?!this._checkPropertiesKey(e)&&(logger.warn("Check the parameter format. The properties key must start with a letter, contain digits, letters, and underscores (_), and contain a maximum of 50 characters"),1):(logger.warn("properties can be none, but it must be an object"),1)))}},{key:"propertiesMust",value:function(e){return this.stripProperties(e),void 0===e||!_.isObject(e)||_.isEmptyObject(e)?(logger.warn("properties must be an object with a value"),!1):!!this._checkPropertiesKey(e)||(logger.warn("Check the parameter format. The properties key must start with a letter, contain digits, letters, and underscores (_), and contain a maximum of 50 characters"),!1)}},{key:"userId",value:function(e){return!(!_.isString(e)||!/^.{1,64}$/.test(e))||(logger.warn("The user ID must be a string of less than 64 characters and cannot be null"),!1)}},{key:"userAddProperties",value:function(e){if(!this.propertiesMust(e))return!1;for(var t in e)if(!_.isNumber(e[t]))return logger.warn("The attributes of userAdd need to be Number"),!1;return!0}},{key:"userAppendProperties",value:function(e){if(!this.propertiesMust(e))return!1;for(var t in e)if(!_.isArray(e[t]))return logger.warn("The attribute of userAppend must be Array"),!1;return!0}}]),e}(),PlatformProxy=function(){function e(){_classCallCheck(this,e),this.config={persistenceName:"GravityEngine",persistenceNameOld:"GravityEngine_quick_mp",asyncPersistence:!0}}return _createClass(e,[{key:"getConfig",value:function(){return this.config||{}}},{key:"getStorage",value:function(e,t,r){t||logger.warn("GravityAnalytics: invalid storage configuration"),storage.get({key:e,success:function(e){e=_.isJSONString(e)?JSON.parse(e):{};r(e)},fail:function(){logger.warn("GravityAnalytics: getStorage faild"),r({})}})}},{key:"setStorage",value:function(e,t){storage.set({key:e,value:t})}},{key:"getSystemInfo",value:function(n){device.getInfo({success:function(e){var t=e,r=[e.osType,e.osVersionName].join(" ");t.system=r,t.screenWidth=e.screenWidth/(0<e.screenDensity?e.screenDensity:1),t.screenHeight=e.screenHeight/(0<e.screenDensity?e.screenDensity:1),t.mp_platform="quickapp",n.success(t)},complete:function(){n.complete()}})}},{key:"getQuickDevice",value:function(r){var n={};device.getId({type:["device","mac","user"],success:function(e){for(var t in e)n[t]=e[t];device.getInfo({success:function(e){for(var t in e)n[t]=e[t];r.success(n)}})}})}},{key:"getNetworkType",value:function(t){network.getType({success:function(e){t.success({networkType:e.type})},complete:function(){t.complete()}})}},{key:"onNetworkStatusChange",value:function(t){network.subscribe({callback:function(e){t({networkType:e.type})}})}},{key:"request",value:function(r){return fetch.fetch({url:r.url,data:r.data,method:r.method,header:r.header,success:function(e){var t={};t.statusCode=e.code,_.isJSONString(e.data)&&(t.data=JSON.parse(e.data)),r.success(t)},fail:function(e){var t={};t.errMsg=e.message,r.fail(t)}})}},{key:"initAutoTrackInstance",value:function(){logger.warn("GravityAnalytics: Quick App does not support automatic collection. You can contact GE support personnel to collect related events")}},{key:"setGlobal",value:function(e,t){globalThis[t]=e}},{key:"getAppOptions",value:function(){return{}}},{key:"showToast",value:function(e){prompt.showToast({message:e,duration:2e3})}}],[{key:"createInstance",value:function(){return new e}}]),e}(),PlatformAPI=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"_getCurrentPlatform",value:function(){return this.currentPlatform||(this.currentPlatform=PlatformProxy.createInstance())}},{key:"getConfig",value:function(){return this._getCurrentPlatform().getConfig()}},{key:"getStorage",value:function(e,t,r){return this._getCurrentPlatform().getStorage(e,t,r)}},{key:"setStorage",value:function(e,t){return this._getCurrentPlatform().setStorage(e,t)}},{key:"getSystemInfo",value:function(e){return this._getCurrentPlatform().getSystemInfo(e)}},{key:"getNetworkType",value:function(e){return this._getCurrentPlatform().getNetworkType(e)}},{key:"getQuickDevice",value:function(e){return this._getCurrentPlatform().getQuickDevice(e)}},{key:"onNetworkStatusChange",value:function(e){this._getCurrentPlatform().onNetworkStatusChange(e)}},{key:"request",value:function(e){return this._getCurrentPlatform().request(e)}},{key:"initAutoTrackInstance",value:function(e,t){return this._getCurrentPlatform().initAutoTrackInstance(e,t)}},{key:"setGlobal",value:function(e,t){e&&t&&this._getCurrentPlatform().setGlobal(e,t)}},{key:"getAppOptions",value:function(e){return this._getCurrentPlatform().getAppOptions(e)}},{key:"showDebugToast",value:function(e){this._getCurrentPlatform().showToast(e)}}]),e}(),HttpTask=function(){function s(e,t,r,n,i,o){_classCallCheck(this,s),this.data=e,this.serverUrl=t,this.callback=o,this.debugMode=i,this.tryCount=_.isNumber(r)?r:1,this.permissionTryCount=6,this.timeout=_.isNumber(n)?n:3e3,this.taClassName="HttpTask"}return _createClass(s,[{key:"run",value:function(){var r=this,e=_.createExtraHeaders(),t=(e["content-type"]="application/json","debug"===this.debugMode&&(e["Turbo-Debug-Mode"]=1),PlatformAPI.request({url:this.serverUrl,method:"POST",data:this.data,header:e,success:function(e){var t;0===(null==e||null==(t=e.data)?void 0:t.code)?r.onSuccess(e):r.onFailed(e)},fail:function(e){r.onFailed(e)}}));setTimeout(function(){(_.isObject(t)||_.isPromise(t))&&_.isFunction(t.abort)&&t.abort()},this.timeout)}},{key:"onSuccess",value:function(e){var t,r;200===e.statusCode?(r="Data Verified",null!=e&&null!=(t=e.data)&&null!=(t=t.extra)&&null!=(t=t.errors)&&t.length&&(r=e.data.extra.errors),this.callback({code:null==e||null==(t=e.data)?void 0:t.code,msg:r})):this.callback({code:-3,msg:e.statusCode})}},{key:"onFailed",value:function(e){var t,r=this;0<--this.tryCount?setTimeout(function(){r.run()},1e3):this.callback({code:-3,msg:"".concat(null==e||null==(t=e.data)?void 0:t.msg,"：").concat(null==e||null==(t=e.data)||null==(t=t.extra)?void 0:t.error)})}}]),s}(),SenderQueue=function(){function e(){_classCallCheck(this,e),this.items=[],this.isRunning=!1,this.showDebug=!1}return _createClass(e,[{key:"enqueue",value:function(e,t,r){var n=!(3<arguments.length&&void 0!==arguments[3])||arguments[3],i="debug"===r.debugMode,o=this,e=new HttpTask(JSON.stringify(e),t,r.maxRetries,r.sendTimeout,r.debugMode,function(e){o.isRunning=!1,_.isFunction(r.callback)&&r.callback(e),o._runNext(i),i&&logger.info("code ".concat(e.code," and msg is ").concat(e.msg))});!0===n?(this.items.push(e),this._runNext(i)):e.run()}},{key:"_dequeue",value:function(){return this.items.shift()}},{key:"_runNext",value:function(e){if(0<this.items.length&&!this.isRunning)if(this.isRunning=!0,e)this._dequeue().run();else{for(var t=this.items.splice(0,this.items.length),e=t[0],r=JSON.parse(e.data),n=1;n<t.length;n++){var i=t[n],i=JSON.parse(i.data);r.event_list=r.event_list.concat(i.event_list)}var o=(new Date).getTime();r.$flush_time=o,new HttpTask(JSON.stringify(r),e.serverUrl,e.tryCount,e.timeout,null==e?void 0:e.debugMode,e.callback).run()}}}]),e}(),senderQueue=new SenderQueue,DEFAULT_CONFIG={name:"GravityEngine",is_plugin:!1,maxRetries:3,sendTimeout:5e3,enablePersistence:!0,asyncPersistence:!1,strict:!1,debugMode:"none"},systemInformation={properties:{$lib_version:Config.LIB_VERSION,$lib:Config.LIB_STACK,$scene:"",$today_first_scene:""},getSystemInfo:function(e){var r=this;PlatformAPI.onNetworkStatusChange(function(e){r.properties.$network_type=e.networkType}),PlatformAPI.getNetworkType({success:function(e){r.properties.$network_type=e.networkType},complete:function(){PlatformAPI.getSystemInfo({success:function(e){logger.info(JSON.stringify(e,null,4));var t={$manufacturer:e.brand,$brand:e.brand,$model:e.model,$screen_width:Number(e.screenWidth),$screen_height:Number(e.screenHeight),$system_language:e.language,$os:e.platform,$os_version:e.system};_.extend(r.properties,t),_.setMpPlatform(e.mp_platform)},complete:function(){e()}})}})}},GravityEnginePersistence=function(){function e(t,r){var n=this;_classCallCheck(this,e),this.enabled=t.enablePersistence,this.enabled?(t.isChildInstance?(this.name=t.persistenceName+"_"+t.name,this.nameOld=t.persistenceNameOld+"_"+t.name):(this.name=t.persistenceName,this.nameOld=t.persistenceNameOld),t.asyncPersistence?(this._state={},PlatformAPI.getStorage(this.name,!0,function(e){_.isEmptyObject(e)?PlatformAPI.getStorage(n.nameOld,!0,function(e){n._state=_.extend2Layers({},e,n._state),n._init(t,r),n._save()}):(n._state=_.extend2Layers({},e,n._state),n._init(t,r),n._save())})):(this._state=PlatformAPI.getStorage(this.name)||{},_.isEmptyObject(this._state)&&(this._state=PlatformAPI.getStorage(this.nameOld)||{}),this._init(t,r))):(this._state={},this._init(t,r))}return _createClass(e,[{key:"_init",value:function(e,t){this.getDistinctId()||this.setDistinctId(_.UUID()),e.isChildInstance||this.getDeviceId()||this._setDeviceId(_.UUID()),this.initComplete=!0,"function"==typeof t&&t();var e=PlatformAPI.getStorage(this.name),t=null==e?void 0:e.current_first_scene_date,r=null==e?void 0:e.current_first_scene,n=(new Date).toLocaleDateString();r&&t&&t===n?systemInformation.properties.$today_first_scene=String(null==e?void 0:e.current_first_scene):(r=String(PlatformAPI.getAppOptions().scene||PlatformAPI.getAppOptions().from),systemInformation.properties.$today_first_scene=r,this._state.current_first_scene=r,this._state.current_first_scene_date=n),this._save()}},{key:"_save",value:function(){this.enabled&&this.initComplete&&PlatformAPI.setStorage(this.name,JSON.stringify(this._state))}},{key:"_set",value:function(e,t){var r,n=this;"string"==typeof e?(r={})[e]=t:"object"===_typeof(e)&&(r=e),_.each(r,function(e,t){n._state[t]=e}),this._save()}},{key:"_get",value:function(e){return this._state[e]}},{key:"setEventTimer",value:function(e,t){var r=this._state.event_timers||{};r[e]=t,this._set("event_timers",r)}},{key:"removeEventTimer",value:function(e){var t=(this._state.event_timers||{})[e];return _.isUndefined(t)||(delete this._state.event_timers[e],this._save()),t}},{key:"getDeviceId",value:function(){return this._state.device_id}},{key:"_setDeviceId",value:function(e){this.getDeviceId()?logger.warn("cannot modify the device id."):this._set("device_id",e)}},{key:"getDistinctId",value:function(){return this._state.distinct_id}},{key:"setDistinctId",value:function(e){this._set("distinct_id",e)}},{key:"getAccountId",value:function(){return this._state.account_id}},{key:"setAccountId",value:function(e){this._set("account_id",e)}},{key:"getSuperProperties",value:function(){return this._state.props||{}}},{key:"setSuperProperties",value:function(e,t){t=t?e:_.extend(this.getSuperProperties(),e);this._set("props",t)}}]),e}();function getPlatFormName(){return PlatformAPI.getConfig().persistenceNameOld}var GravityEngineAPI=function(){function r(e){_classCallCheck(this,r),e.appId=_.checkAppId((null==e?void 0:e.clientId)||""),e.accessToken=e.accessToken,e.accessToken||console.warn("GravityAnalytics: accessToken must be required"),e.serverUrl="".concat(Config.BASE_URL,"/event/collect/?access_token=").concat(e.accessToken);var t=_.extend({},DEFAULT_CONFIG,PlatformAPI.getConfig());_.isObject(e)?this.config=_.extend(t,e):this.config=t,this._init(this.config)}var e,t,n;return _createClass(r,[{key:"_init",value:function(e){var t=this,r=(this.name=e.name,this.appId=e.clientId,this.accessToken=e.accessToken,e.serverUrl||e.server_url);this.serverUrl=r,this.serverDebugUrl=r,this.configUrl=r+"/config",this.autoTrackProperties={},this._queue=[],this.config.syncBatchSize=100,this.config.syncInterval=60,e.isChildInstance?this._state={}:(logger.enabled="debug"===e.debugMode,this.instances=[],this._state={getSystemInfo:!1,initComplete:!1},systemInformation.getSystemInfo(function(){t._updateState({getSystemInfo:!0})}),PlatformAPI.setGlobal(this,this.name)),systemInformation.properties.$scene=String(PlatformAPI.getAppOptions().scene||PlatformAPI.getAppOptions().from),this.store=new GravityEnginePersistence(e,function(){t.config.asyncPersistence&&_.isFunction(t.config.persistenceComplete)&&t.config.persistenceComplete(t),t._updateState()}),this.enabled=!_.isBoolean(this.store._get("ge_enabled"))||this.store._get("ge_enabled"),this.isOptOut=!!_.isBoolean(this.store._get("ge_isOptOut"))&&this.store._get("ge_isOptOut"),"GravityEngine_wechat_game"!==getPlatFormName()&&"GravityEngine_tt_game"!==getPlatFormName()||!e.autoTrack.appLaunch||this.track("$MPLaunch",{$url_query:this.setQuery(this.getQuery())}),!e.isChildInstance&&e.autoTrack&&(this.autoTrack=PlatformAPI.initAutoTrackInstance(this,e))}},{key:"updateConfig",value:function(e,t){}},{key:"initInstance",value:function(e,t){if(!this.config.isChildInstance)return _.isString(e)&&e!==this.name&&_.isUndefined(this[e])?(t=new r(_.extend({},this.config,{enablePersistence:!1,isChildInstance:!0,name:e},t)),this[e]=t,this.instances.push(e),this[e]._state=this._state,t):void logger.warn("initInstance() failed due to the name is invalid: "+e);logger.warn("initInstance() cannot be called on child instance")}},{key:"lightInstance",value:function(e){return this[e]}},{key:"_setAutoTrackProperties",value:function(e){_.extend(this.autoTrackProperties,e)}},{key:"setupAndStart",value:function(e){if(null!=e&&e.clientId&&(this.config.appId=e.clientId,this.appId=e.clientId),this._state.initComplete)return!1;this._updateState({initComplete:!0})}},{key:"_isReady",value:function(){return this._state.getSystemInfo&&this._state.initComplete&&this.store.initComplete&&this.config.appId&&this.config.accessToken}},{key:"_updateState",value:function(e){var t=this;_.isObject(e)&&_.extend(this._state,e),this._onStateChange(),_.each(this.instances,function(e){t[e]._onStateChange()})}},{key:"_onStateChange",value:function(){var t=this;this._isReady()&&this._queue&&0<this._queue.length&&(_.each(this._queue,function(e){t[e[0]].apply(t,slice.call(e[1]))}),this._queue=[])}},{key:"_hasDisabled",value:function(){var e=!this.enabled||this.isOptOut;return e&&logger.info("GravityEngine is Pause or Stop!"),e}},{key:"_sendRequest",value:function(e,t,r){var n,i;this._hasDisabled()||(!_.isUndefined(this.config.disableEventList)&&this.config.disableEventList.includes(e.eventName)?logger.info("disabled Event : "+e.eventName):(t=_.isDate(t)?t:new Date,(t={event_list:[{type:e.type,time:new Date(t).getTime()}]}).event_list[0].event=e.eventName,"track"===e.type?(t.event_list[0].properties=this.getSendProperties(),n=this.store.removeEventTimer(e.eventName),_.isUndefined(n)||(n=(new Date).getTime()-n,86400<(n=parseFloat((n/1e3).toFixed(3)))?n=86400:n<0&&(n=0),t.event_list[0].properties.$event_duration=n)):t.event_list[0].properties={},_.isObject(e.properties)&&!_.isEmptyObject(e.properties)&&_.extend(t.event_list[0].properties,e.properties),_.searchObjDate(t.event_list[0]),t.client_id=this.appId,logger.info(JSON.stringify(t,null,4)),n=this.serverUrl,_.isBoolean(this.config.enableEncrypt)&&1==this.config.enableEncrypt&&(t.event_list[0]=_.generateEncryptyData(t.event_list[0],void 0)),r?(r=new FormData,"debug"===this.config.debugMode?(r.append("source","client"),r.append("appid",this.appId),r.append("deviceId",this.getDeviceId()),r.append("data",JSON.stringify(t.event_list[0]))):(i=_.base64Encode(JSON.stringify(t)),r.append("data",i)),navigator.sendBeacon(n,r),_.isFunction(e.onComplete)&&e.onComplete({statusCode:200})):senderQueue.enqueue(t,n,{maxRetries:this.config.maxRetries,sendTimeout:this.config.sendTimeout,callback:e.onComplete,debugMode:this.config.debugMode})))}},{key:"_isObjectParams",value:function(e){return _.isObject(e)&&_.isFunction(e.onComplete)}},{key:"track",value:function(e,t,r,n){var i;this._hasDisabled()||(this._isObjectParams(e)&&(e=(i=e).eventName,t=i.properties,r=i.time,n=i.onComplete),PropertyChecker.event(e)&&PropertyChecker.properties(t)||!this.config.strict?this._internalTrack(e,t,r,n):_.isFunction(n)&&n({code:-1,msg:"invalid parameters"}))}},{key:"_internalTrack",value:function(e,t,r,n,i){this._hasDisabled()||(r=_.isDate(r)?r:new Date,this._isReady()?this._sendRequest({type:"track",eventName:e,properties:t,onComplete:n},r,i):this._queue.push(["_internalTrack",[e,t,r,n]]))}},{key:"userSet",value:function(e,t,r){var n;this._hasDisabled()||(this._isObjectParams(e)&&(e=(n=e).properties,t=n.time,r=n.onComplete),PropertyChecker.propertiesMust(e)||!this.config.strict?(t=_.isDate(t)?t:new Date,this._isReady()?this._sendRequest({type:"profile",eventName:"profile_set",properties:e,onComplete:r},t):this._queue.push(["userSet",[e,t,r]])):(logger.warn("calling userSet failed due to invalid arguments"),_.isFunction(r)&&r({code:-1,msg:"invalid parameters"})))}},{key:"userSetOnce",value:function(e,t,r){var n;this._hasDisabled()||(this._isObjectParams(e)&&(e=(n=e).properties,t=n.time,r=n.onComplete),PropertyChecker.propertiesMust(e)||!this.config.strict?(t=_.isDate(t)?t:new Date,this._isReady()?this._sendRequest({type:"profile",eventName:"profile_set_once",properties:e,onComplete:r},t):this._queue.push(["userSetOnce",[e,t,r]])):(logger.warn("calling userSetOnce failed due to invalid arguments"),_.isFunction(r)&&r({code:-1,msg:"invalid parameters"})))}},{key:"userAdd",value:function(e,t,r){var n;this._hasDisabled()||(this._isObjectParams(e)&&(e=(n=e).properties,t=n.time,r=n.onComplete),PropertyChecker.propertiesMust(e)||!this.config.strict?(t=_.isDate(t)?t:new Date,this._isReady()?this._sendRequest({type:"profile",eventName:"profile_increment",properties:e,onComplete:r},t):this._queue.push(["userAdd",[e,t,r]])):(logger.warn("calling userAdd failed due to invalid arguments"),_.isFunction(r)&&r({code:-1,msg:"invalid parameters"})))}},{key:"userNumberMax",value:function(e,t,r){if(!this._hasDisabled()){var n,i,o;for(i in this._isObjectParams(e)&&(e=(n=e).properties,t=n.time,r=n.onComplete),e)if("number"!=typeof e[i])return o="The key ".concat(i," must be type of number"),console.warn(o),void(_.isFunction(r)&&r({code:-1,msg:o}));PropertyChecker.propertiesMust(e)||!this.config.strict?(t=_.isDate(t)?t:new Date,this._isReady()?this._sendRequest({type:"profile",eventName:"profile_number_max",properties:e,onComplete:r},t):this._queue.push(["userNumberMax",[e,t,r]])):(logger.warn("calling userNumberMax failed due to invalid arguments"),_.isFunction(r)&&r({code:-1,msg:"invalid parameters"}))}}},{key:"userNumberMin",value:function(e,t,r){if(!this._hasDisabled()){var n,i,o;for(i in this._isObjectParams(e)&&(e=(n=e).properties,t=n.time,r=n.onComplete),e)if("number"!=typeof e[i])return o="The key ".concat(i," must be type of number"),console.warn(o),void(_.isFunction(r)&&r({code:-1,msg:o}));PropertyChecker.propertiesMust(e)||!this.config.strict?(t=_.isDate(t)?t:new Date,this._isReady()?this._sendRequest({type:"profile",eventName:"profile_number_min",properties:e,onComplete:r},t):this._queue.push(["userNumberMin",[e,t,r]])):(logger.warn("calling userNumberMin failed due to invalid arguments"),_.isFunction(r)&&r({code:-1,msg:"invalid parameters"}))}}},{key:"userDel",value:function(e,t){var r,n={};this._hasDisabled()||(this._isObjectParams(n)&&(n=(r=n).properties,e=r.time,t=r.onComplete),PropertyChecker.propertiesMust(n)||!this.config.strict?(e=_.isDate(e)?e:new Date,this._isReady()?this._sendRequest({type:"profile",eventName:"profile_delete",properties:n,onComplete:t},e):this._queue.push(["userDel",[n,e,t]])):(logger.warn("calling userDel failed due to invalid arguments"),_.isFunction(t)&&t({code:-1,msg:"invalid parameters"})))}},{key:"userAppend",value:function(e,t,r){var n;this._hasDisabled()||(this._isObjectParams(e)&&(e=(n=e).properties,t=n.time,r=n.onComplete),PropertyChecker.propertiesMust(e)||!this.config.strict?(t=_.isDate(t)?t:new Date,this._isReady()?this._sendRequest({type:"profile",eventName:"profile_append",properties:e,onComplete:r},t):this._queue.push(["userAppend",[e,t,r]])):(logger.warn("calling userAppend failed due to invalid arguments"),_.isFunction(r)&&r({code:-1,msg:"invalid parameters"})))}},{key:"userUniqAppend",value:function(e,t,r){var n;this._hasDisabled()||(this._isObjectParams(e)&&(e=(n=e).properties,t=n.time,r=n.onComplete),PropertyChecker.userAppendProperties(e)||!this.config.strict?(t=_.isDate(t)?t:new Date,this._isReady()?this._sendRequest({type:"profile",eventName:"profile_uniq_append",properties:e,onComplete:r},t):this._queue.push(["userUniqAppend",[e,t,r]])):(logger.warn("calling userAppend failed due to invalid arguments"),_.isFunction(r)&&r({code:-1,msg:"invalid parameters"})))}},{key:"userUnset",value:function(e,t,r){var n,e=_defineProperty({},e,null);this._hasDisabled()||(this._isObjectParams(e)&&(e=(n=e).properties,t=n.time,r=n.onComplete),PropertyChecker.propertiesMust(e)||!this.config.strict?(t=_.isDate(t)?t:new Date,this._isReady()?this._sendRequest({type:"profile",eventName:"profile_unset",properties:e,onComplete:r},t):this._queue.push(["userUnset",[e,t,r]])):(logger.warn("calling userUnset failed due to invalid arguments"),_.isFunction(r)&&r({code:-1,msg:"invalid parameters"})))}},{key:"uploadDeviceInfo",value:function(){var s=this;return new Promise(function(i,o){var t;PlatformAPI.getQuickDevice({success:(t=_asyncToGenerator(_regeneratorRuntime().mark(function e(t){var r,n;return _regeneratorRuntime().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r={os_name:"android",android_id:t.user,imei:t.device,oaid:t.device,mac:t.mac,android_version:t.system,api_version:t.osVersionCode,rom:t.vendorOsName,rom_version:t.vendorOsVersion,phone_brand:t.manufacturer,phone_model:t.model},n="".concat(Config.BASE_URL,"/user/device_info/?access_token=").concat(s.accessToken,"&client_id=").concat(s.appId),e.next=4,s.sendNetWork(n,{data:r});case 4:return n=e.sent,e.abrupt("return",(0===n.code?i:o)(n));case 6:case"end":return e.stop()}},e)})),function(e){return t.apply(this,arguments)})})})}},{key:"logoutEvent",value:function(){this.track("$MPLogout",{})}},{key:"loginEvent",value:function(){this.track("$MPLogin",{})}},{key:"registerEvent",value:function(){"GravityEngine_quick_mp"===getPlatFormName()?this.track("$AppRegister",{}):this.track("$MPRegister",{})}},{key:"payEvent",value:function(e,t,r,n,i){if("number"!=typeof e)throw new Error("pay_amount must be a number");if("string"!=typeof t)throw new Error("pay_type must be a string");if("string"!=typeof r)throw new Error("order_id must be a string");if("string"!=typeof n)throw new Error("pay_reason must be a string");if("string"!=typeof i)throw new Error("pay_method must be a string");this.track("$PayEvent",{$pay_amount:e,$pay_type:t,$order_id:r,$pay_reason:n,$pay_method:i})}},{key:"bindTAThirdPlatform",value:function(e,t){if(!e&&!t)throw new Error("taAccountId or taDistinctId must be required");if(e&&"string"!=typeof e)throw new Error("taAccountId must be a string");if(t&&"string"!=typeof t)throw new Error("taDistinctId must be a string");this.track("$BindThirdPlatform",{$third_platform_type:"ta",$ta_account_id:e,$ta_distinct_id:t})}},{key:"adShowEvent",value:function(e,t,r){var n=getPlatFormName();if("GravityEngine_wechat"===n||"GravityEngine_wechat_game"===n){if("string"!=typeof e)throw new Error("ad_type must be a string");if("string"!=typeof t)throw new Error("ad_unit_id must be a string");n={$ad_type:e,$ad_unit_id:t,$adn_type:"wechat"};"[object Object]"===Object.prototype.toString.call(r)&&Object.assign(n,r),this.track("$AdShow",n)}}},{key:"getQuery",value:function(){return PlatformAPI.getAppOptions().query||{}}},{key:"setQuery",value:function(e){var t,r=[];for(t in e)e.hasOwnProperty(t)&&r.push(encodeURIComponent(t)+"="+encodeURIComponent(e[t]));return r.join("&")}},{key:"sendNetWork",value:function(e,n){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"POST";return new Promise(function(t,r){PlatformAPI.request({url:e,method:i,data:"string"==typeof n?n:JSON.stringify(n),header:{"content-type":"application/json"},success:function(e){200===e.statusCode?t(e.data):r(e)},fail:function(e){r(e)}})})}},{key:"_errorPromise",value:function(e){return Promise.reject(new Error(e))}},{key:"initializeWithHistoryUserInfo",value:(n=_asyncToGenerator(_regeneratorRuntime().mark(function e(){var t,r,n=arguments;return _regeneratorRuntime().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=0<n.length&&void 0!==n[0]?n[0]:{},r=1<n.length?n[1]:void 0,e.abrupt("return",this.initialize(t,r));case 3:case"end":return e.stop()}},e,this)})),function(){return n.apply(this,arguments)})},{key:"initialize",value:(t=_asyncToGenerator(_regeneratorRuntime().mark(function e(){var m,g,y=this,t=arguments;return _regeneratorRuntime().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return m=0<t.length&&void 0!==t[0]?t[0]:{},g=1<t.length?t[1]:void 0,e.abrupt("return",new Promise(function(){var r=_asyncToGenerator(_regeneratorRuntime().mark(function e(h,d){return _regeneratorRuntime().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:PlatformAPI.getStorage("is_ge_registered",!0,function(){var t=_asyncToGenerator(_regeneratorRuntime().mark(function e(t){var r,n,i,o,s,a,c,u,l,p,f;return _regeneratorRuntime().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r="",y._state.initComplete?null!=m&&m.name?null!=m&&m.version||0===(null==m?void 0:m.version)?_.isNumber(null==m?void 0:m.version)&&"number"==typeof(null==m?void 0:m.version)?void 0!==g&&("[object Object]"!==Object.prototype.toString.call(g)?r="history_info must be type: Object":null!=g&&g.company?"string"!=typeof g.company?r="history_info.company must be type: String":null!=g&&g.create_time||0===g.create_time?_.isNumber(g.create_time)&&"number"==typeof g.create_time||(r="history_info.create_time must be type: Number"):r="history_info.create_time must be required":r="history_info.company must be required"):r="version must be type: Number":r="version must be required":r="name must be required":r="initialize must be called after setupAndStart",r)return e.abrupt("return",y._errorPromise(r));e.next=4;break;case 4:return r=y.getQuery(),n=(null==m?void 0:m.channel)||"base_channel",s={client_id:y.appId,name:m.name,channel:n,version:m.version,wx_openid:(null==m?void 0:m.openid)||(null==m?void 0:m.wx_openid)||"",wx_unionid:(null==m?void 0:m.wx_unionid)||"",promoted_object_id:(null==m?void 0:m.promoted_object_id)||"",need_return_attribution:(null==m?void 0:m.enable_sync_attribution)||!1,ad_data:r},g&&(s.history_info=g),o="".concat(Config.BASE_URL,"/user/initialize/?access_token=").concat(y.accessToken),e.next=11,y.sendNetWork(o,s);case 11:if(0!==(i=e.sent).code)return e.abrupt("return",d(i));e.next=14;break;case 14:return"GravityEngine_quick_mp"===getPlatFormName()&&y.uploadDeviceInfo(),o=systemInformation.properties,s=new Date,p=s.getFullYear(),f=("0"+(s.getMonth()+1)).slice(-2),a=("0"+s.getDate()).slice(-2),c=("0"+s.getHours()).slice(-2),u=("0"+s.getMinutes()).slice(-2),l=("0"+s.getSeconds()).slice(-2),p="".concat(p,"-").concat(f,"-").concat(a," ").concat(c,":").concat(u,":").concat(l),"Y"!==t&&(y.userSetOnce({$channel:n,$manufacturer:o.$manufacturer,$model:o.$model,$brand:o.$brand,$os:o.$os,$first_visit_time:p,$first_scene:String(PlatformAPI.getAppOptions().scene)}),f=y.setQuery(y.getQuery()),y.track("$MPLaunch",{$url_query:f}),y.track("$MPShow",{$url_query:f})),PlatformAPI.setStorage("is_ge_registered",JSON.stringify("Y")),e.abrupt("return",h(i));case 27:case"end":return e.stop()}},e)}));return function(e){return t.apply(this,arguments)}}());case 1:case"end":return e.stop()}},e)}));return function(e,t){return r.apply(this,arguments)}}()));case 3:case"end":return e.stop()}},e)})),function(){return t.apply(this,arguments)})},{key:"queryUserInfo",value:(e=_asyncToGenerator(_regeneratorRuntime().mark(function e(){var i=this;return _regeneratorRuntime().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this._state.initComplete){e.next=2;break}return e.abrupt("return",this._errorPromise("queryUserInfo must be called after setupAndStart"));case 2:return e.abrupt("return",new Promise(function(){var r=_asyncToGenerator(_regeneratorRuntime().mark(function e(t,r){var n;return _regeneratorRuntime().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n="".concat(Config.BASE_URL,"/user/get/?access_token=").concat(i.accessToken,"&client_id=").concat(i.appId),e.next=3,i.sendNetWork(n,{},"GET");case 3:return n=e.sent,e.abrupt("return",(0===n.code?t:r)(n));case 5:case"end":return e.stop()}},e)}));return function(e,t){return r.apply(this,arguments)}}()));case 3:case"end":return e.stop()}},e,this)})),function(){return e.apply(this,arguments)})},{key:"authorizeOpenID",value:function(e){this.identify(e)}},{key:"identify",value:function(e){if(!this._hasDisabled()){if("number"==typeof e)e=String(e);else if("string"!=typeof e)return!1;this.store.setDistinctId(e)}}},{key:"getDistinctId",value:function(){return this.store.getDistinctId()}},{key:"login",value:function(e){if(!this._hasDisabled()){if("number"==typeof e)e=String(e);else if("string"!=typeof e)return!1;this.store.setAccountId(e)}}},{key:"getAccountId",value:function(){return this.store.getAccountId()}},{key:"logout",value:function(){this._hasDisabled()||this.store.setAccountId(null)}},{key:"setSuperProperties",value:function(e){this._hasDisabled()||(PropertyChecker.propertiesMust(e)||!this.config.strict?this.store.setSuperProperties(e):logger.warn("setSuperProperties parameter must be a valid property value"))}},{key:"registerApp",value:function(e){this.setSuperProperties(e)}},{key:"clearSuperProperties",value:function(){this._hasDisabled()||this.store.setSuperProperties({},!0)}},{key:"unsetSuperProperty",value:function(e){var t;this._hasDisabled()||_.isString(e)&&(delete(t=this.getSuperProperties())[e],this.store.setSuperProperties(t,!0))}},{key:"getSuperProperties",value:function(){return this.store.getSuperProperties()}},{key:"getSendProperties",value:function(){try{var e,t=_.extend({},systemInformation.properties,this.autoTrackProperties,this.store.getSuperProperties(),this.dynamicProperties?this.dynamicProperties():{});for(e in t)"string"==typeof t[e]&&(t[e]=t[e].substring(0,8192));return t}catch(e){return{}}}},{key:"getPresetProperties",value:function(){var e=systemInformation.properties,t={},r=e.$system_language,r=(t.system_language=_.isUndefined(r)?"":r,e.$os),r=(t.os=_.isUndefined(r)?"":r,e.$screen_width),r=(t.screenWidth=_.isUndefined(r)?0:r,e.$screen_height),r=(t.screenHeight=_.isUndefined(r)?0:r,e.$network_type),r=(t.networkType=_.isUndefined(r)?"":r,e.$model),r=(t.deviceModel=_.isUndefined(r)?"":r,e.$os_version),r=(t.osVersion=_.isUndefined(r)?"":r,t.deviceId=this.getDeviceId(),0-(new Date).getTimezoneOffset()/60),r=(t.zoneOffset=r,e.$manufacturer),r=(t.manufacturer=_.isUndefined(r)?"":r,e.$manufacturer);return t.brand=_.isUndefined(r)?"":r,t.toEventPresetProperties=function(){return{$app_id:this.appId,$model:t.deviceModel,$screen_width:t.screenWidth,$screen_height:t.screenHeight,$system_language:t.system_language,$os:t.os,$os_version:t.osVersion,$network_type:t.networkType,$manufacturer:t.manufacturer,$brand:t.manufacturer,$scene:String(PlatformAPI.getAppOptions().scene||PlatformAPI.getAppOptions().from)}},t}},{key:"setDynamicSuperProperties",value:function(e){this._hasDisabled()||("function"==typeof e?PropertyChecker.properties(e())||!this.config.strict?this.dynamicProperties=e:logger.warn("A dynamic public property must return a valid property value"):logger.warn("setDynamicSuperProperties parameter must be a function type"))}},{key:"timeEvent",value:function(e,t){this._hasDisabled()||(t=_.isDate(t)?t:new Date,this._isReady()?PropertyChecker.event(e)||!this.config.strict?this.store.setEventTimer(e,t.getTime()):logger.warn("calling timeEvent failed due to invalid eventName: "+e):this._queue.push(["timeEvent",[e,t]]))}},{key:"getDeviceId",value:function(){return systemInformation.properties.$device_id}},{key:"enableTracking",value:function(e){this.enabled=e,this.store._set("ta_enabled",e)}},{key:"optOutTracking",value:function(){this.store.setSuperProperties({},!0),this.store.setDistinctId(_.UUID()),this.store.setAccountId(null),this._queue.splice(0,this._queue.length),this.isOptOut=!0,this.store._set("ge_isOptOut",!0)}},{key:"optOutTrackingAndDeleteUser",value:function(){var e=new Date;this._sendRequest({type:"user_del"},e),this.optOutTracking()}},{key:"optInTracking",value:function(){this.isOptOut=!1,this.store._set("ge_isOptOut",!1)}},{key:"setTrackStatus",value:function(e){switch(e){case"PAUSE":this.eventSaveOnly=!1,this.optInTracking(),this.enableTracking(!1);break;case"STOP":this.eventSaveOnly=!1,this.optOutTracking(!0);break;default:this.eventSaveOnly=!1,this.optInTracking(),this.enableTracking(!0)}}}]),r}();module.exports=GravityEngineAPI;